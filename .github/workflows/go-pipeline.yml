name: Go Pipeline

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "go-app/**"
      - ".github/workflows/go-pipeline.yml"
      - "k8s/go-deployment.yaml"

env:
  GO_IMAGE_TAG: ${{ secrets.DOCKER_USERNAME }}/go-web-app:${{ github.sha }}

jobs:
  lint-security:
    name: Lint & Security
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Run GolangCI-Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.61.0
          working-directory: go-app
          args: --timeout=5m

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out results.sarif ./..."
          workdir: go-app

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: go-app/results.sarif
          category: go-security

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install Test Tools
        run: |
          sudo apt-get install -y git
          go install gotest.tools/gotestsum@v1.11.0

      - name: Run Tests
        working-directory: go-app
        run: gotestsum --junitfile report.xml --format testname -- ./...

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          report_paths: "go-app/report.xml"

  build-source:
    name: Build Binary
    runs-on: ubuntu-latest
    needs: [lint-security, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Compile Binary
        working-directory: go-app
        run: CGO_ENABLED=0 GOOS=linux go build -o main .

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-binary
          path: go-app/main
          retention-days: 1

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-source
    steps:
      - uses: actions/checkout@v4

      - name: Download Binary Artifact
        uses: actions/download-artifact@v4
        with:
          name: go-binary
          path: go-app/

      - name: Set Permissions
        run: chmod +x go-app/main

      - name: Build and Save Image
        working-directory: go-app
        run: |
          docker build -t ${{ env.GO_IMAGE_TAG }} .
          docker save -o go-image.tar ${{ env.GO_IMAGE_TAG }}

      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-docker-image
          path: go-app/go-image.tar
          retention-days: 1

  push-image:
    name: Push to DockerHub
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: go-docker-image

      - name: Load and Push
        run: |
          docker load -i go-image.tar
          docker push ${{ env.GO_IMAGE_TAG }}

  deploy:
    name: Deploy to K8s
    runs-on: ubuntu-latest
    needs: push-image
    steps:
      - uses: actions/checkout@v4

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Manifest and Apply
        run: |
          sed -i "s|__IMAGE_PLACEHOLDER__|${{ env.GO_IMAGE_TAG }}|g" k8s/go-deployment.yaml
          cat k8s/go-deployment.yaml
          echo "kubectl apply -f k8s/go-deployment.yaml"
