name: Node Pipeline

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "node-app/**"
      - ".github/workflows/node-pipeline.yml"
      - "k8s/node-deployment.yaml"

env:
  NODE_IMAGE_TAG: ${{ secrets.DOCKER_USERNAME }}/node-web-app:${{ github.sha }}

jobs:
  lint-security:
    name: Lint & Security
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: node-app/package-lock.json

      - name: Install Dependencies
        working-directory: node-app
        run: npm ci

      - name: Run ESLint
        working-directory: node-app
        run: npm run lint

      - name: Run NPM Audit
        working-directory: node-app
        run: npm audit --audit-level=high

      - name: Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/javascript
          generateSarif: "true"
          auditOn: push
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Archive Semgrep Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep.sarif

      - name: Upload SARIF to GitHub Security Tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: node-security

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: node-app/package-lock.json

      - name: Run Jest
        working-directory: node-app
        run: |
          npm ci
          npm test

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: "node-app/junit.xml"

  build-source:
    name: Build Source
    runs-on: ubuntu-latest
    needs: [lint-security, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Prod Dependencies
        working-directory: node-app
        run: npm ci --omit=dev

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-source-files
          path: |
            node-app/node_modules
            node-app/server.js
            node-app/package.json
          retention-days: 1

  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-source
    steps:
      - uses: actions/checkout@v4

      - name: Download Source Artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-source-files
          path: node-app/

      - name: Build and Save Image
        working-directory: node-app
        run: |
          docker build -t ${{ env.NODE_IMAGE_TAG }} .
          docker save -o node-image.tar ${{ env.NODE_IMAGE_TAG }}

      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-docker-image
          path: node-app/node-image.tar
          retention-days: 1

  push-image:
    name: Push to DockerHub
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: node-docker-image

      - name: Load and Push Image
        run: |
          docker load -i node-image.tar
          docker push ${{ env.NODE_IMAGE_TAG }}

  deploy:
    name: Deploy to K8s
    runs-on: ubuntu-latest
    needs: push-image
    steps:
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Apply Manifest
        run: |
          sed -i "s|__IMAGE_PLACEHOLDER__|${{ env.NODE_IMAGE_TAG }}|g" k8s/node-deployment.yaml
          cat k8s/node-deployment.yaml
          echo "kubectl apply -f k8s/node-deployment.yaml"
